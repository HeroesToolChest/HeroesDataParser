jobs:
- template: azure-pipelines-template.yml
  parameters:
    name: Linux
    pool:
      vmImage: 'ubuntu-16.04'

- template: azure-pipelines-template.yml
  parameters:
    name: macOS
    pool:
      vmImage: 'macOS-10.13'
  
- template: azure-pipelines-template.yml
  parameters:
    name: Windows
    pool:
      vmImage: 'vs2017-win2016'
    
- job: Artifacts
  dependsOn:
    - Linux
    - macOS
    - Windows
  pool:
    vmImage: 'vs2017-win2016'
  steps:
    - powershell: dotnet publish HeroesData\HeroesData.csproj -c release -o HeroesData\bin\publish\any\
      displayName: Publish release [fdd-any]

    - powershell: dotnet pack HeroesData\HeroesData.csproj -c release --no-build -o HeroesData\bin\nupkg\any\       
      displayName: Nuget pack [fdd-any]

    - task: DownloadSecureFile@1
      displayName: Download cert
      inputs:
        secureFile: certificate

    - powershell: nuget sign HeroesData\bin\nupkg\any\HeroesDataParser.*.nupkg -CertificatePath $env:DOWNLOADSECUREFILE_SECUREFILEPATH -CertificatePassword $(cert_password) -Timestamper http://timestamp.digicert.com
      displayName: Sign nuget pack

    - powershell: (get-content HeroesData\HeroesData.csproj).Replace('<PackAsTool>true</PackAsTool>','<PackAsTool>false</PackAsTool>') | out-file HeroesData\HeroesData_self.csproj
      displayName: SCD Prep

    - powershell: dotnet publish HeroesData\HeroesData_self.csproj -c release --self-contained -r win-x64 -o HeroesData\bin\publish\win-x64\
      displayName: Publish release [scd-win-x64]

    - powershell: dotnet publish HeroesData\HeroesData_self.csproj -c release --self-contained -r osx-x64 -o HeroesData\bin\publish\osx-x64\
      displayName: Publish release [scd-osx-x64]

    - powershell: dotnet publish HeroesData\HeroesData_self.csproj -c release --self-contained -r linux-x64 -o HeroesData\bin\publish\linux-x64\
      displayName: Publish release [scd-linux-x64]
        
    - task: PublishPipelineArtifact@0
      inputs:
        displayName: Publish Artifact [fdd]
        artifactName: 'HeroesDataParser-fdd-any'
        targetPath: 'HeroesData\bin\publish\any\'

    - task: PublishPipelineArtifact@0
      inputs:
        displayName: Publish Artifact [scd-win-x64]
        artifactName: 'HeroesDataParser-scd-win-x64'
        targetPath: 'HeroesData\bin\publish\win-x64\'

    - task: PublishPipelineArtifact@0
      inputs:
        displayName: Publish Artifact [scd-osx-x64]
        artifactName: 'HeroesDataParser-scd-osx-x64'
        targetPath: 'HeroesData\bin\publish\osx-x64\'

    - task: PublishPipelineArtifact@0
      inputs:
        displayName: Publish Artifact [scd-linux-x64]
        artifactName: 'HeroesDataParser-scd-linux-x64'
        targetPath: 'HeroesData\bin\publish\linux-x64\'

    - task: PublishPipelineArtifact@0
      inputs:
        displayName: Publish Artifact [nuget-pack-fdd-any]
        targetPath: 'HeroesData\bin\nupkg\any\HeroesDataParser.*.nupkg'
      
